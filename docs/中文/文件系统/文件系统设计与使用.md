## 文件系统

文件系统参考的是unix fs实现，但是针对嵌入式进行了优化。

文件进行了基本测试，可以支持基本的读写功能，但掉电保护、备份功能不支持。



## 设计

对节点进行分块，使用位图进行管理。

块的大小可自由配置，但是建议根据目标平台的page大小进行配置，否则可能出现写失败等情况。

一个目录占用一个块，在嵌入式环境下，建议使用一个目录即可。





## 使用

目前只在stm32f1平台上进行了测试。

基本的使用过程：

1.更改链接脚本，给文件系统留一部分空间

2.根据目标平台移植port文件夹里面的接口代码，当然，这里更建议使用者自己编写，因为目前支持的平台只有一种

3.调用API使用

```API
int fs_mount(struct superblock *sb, struct fs_blkdev *bdev);
int fs_unmount(struct superblock *sb);
int fs_format(struct superblock *sb);

int fs_mkdir(const char *path, struct inode **out);
int fs_readdir(const char *path, struct dirent *buf, int max, int *nread);

int fs_open(const char *path, int flags, struct inode **out);
int fs_read(struct inode *inode, uint32_t off, void *buf, uint32_t len);
int fs_write(struct inode *inode, uint32_t off, const void *buf, uint32_t len);
int fs_close(struct inode *inode);

int fs_truncate(struct inode *inode, uint32_t newsize);
int fs_sync(void);
```

### 示例

这里是在shell下操作文件：

```c
int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_USART1_UART_Init();

    comm_init_uart(&huart1);

    struct superblock sb;
    //接口初始化
    fs_port_init();
    //挂载
    if (fs_port_mount(&sb) != 0) {
        printf("FS mount after format failed!\r\n");
    }

    printf("FS mounted OK!\r\n");
    printf("Starting shell...\r\n");

    HAL_Delay(100);
    shell_main(); //这里启动了以前编写的一个shell

    while (1) {}
}
```

在shell里面，cat命令的实现需要涉及到基本的文件操作：

```c
static char cat_buf[128];
int cmd_cat(int argc, char **argv)
{
    if (argc < 2) {
        comm_write("usage: cat FILE\r\n", 18);
        return -1;
    }

    memset(path, 0, sizeof(path));
    make_abs_path(path, argv[1]);

    struct inode *ino;
    if (fs_open(path, 0, &ino) < 0) { //打开
        comm_write("cat: cannot open ", 18);
        comm_write(argv[1], strlen(argv[1]));
        comm_write("\r\n", 2);
        return -1;
    }

    uint32_t off = 0;
    int r;
	// 读取对应的内容
    while ((r = fs_read(ino, off, cat_buf, sizeof(cat_buf))) > 0) {
        for (int i = 0; i < r; i++) {
            if (cat_buf[i] == '\n') {
                comm_write("\r\n", 2);
            } else {
                comm_putc(cat_buf[i]);
            }
        }
        off += r;
    }
    //关闭，这里会提交对应的修改信息
    fs_close(ino);
    return 0;
}
```

